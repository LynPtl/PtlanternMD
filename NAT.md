[![1755148462319.png](https://youke1.picui.cn/s1/2025/08/14/689d709cdff1e.png)](https://youke1.picui.cn/s1/2025/08/14/689d709cdff1e.png)

[![1755148570473.png](https://youke1.picui.cn/s1/2025/08/14/689d7108eb81e.png)](https://youke1.picui.cn/s1/2025/08/14/689d7108eb81e.png)

---
### **第一题: HTTP响应报文中的“目的端口号”**

#### **题干翻译与词汇解释**

> **原句**: Consider the NAT of Figure 2... Now assume that the top-most client (A) in the local network sends an HTTP Request to [http://www.unsw.edu.au](http://www.unsw.edu.au) (which is hosted at IP address: 129.119.103.149) and the local port for the TCP connection on this client is 1000. What could be a possible destination port number in the HTTP response message sent by the UNSW web server in response to this GET request?
>
> **翻译**: 请看图2中的NAT网络。现在假设，本地网络中最上面的客户端(A)向 `http://www.unsw.edu.au` (其IP地址为 `129.119.103.149`) 发送了一个HTTP请求，并且客户端A用于此TCP连接的**本地端口 (local port)** 是1000。请问，当UNSW的Web服务器回复这个GET请求时，在其发送的HTTP**响应报文 (response message)** 中，**目的端口号 (destination port number)** 可能是多少？

* **`HTTP Request` (HTTP请求)**: 你的浏览器向网站服务器请求网页内容时发送的数据包。
* **`hosted at IP address` (托管在IP地址)**: 指网站服务器的IP地址。
* **`local port` (本地端口)**: 指你电脑上为了这次通信临时打开的一个端口号，也叫**源端口号 (source port number)**。
* **`HTTP response message` (HTTP响应报文)**: 网站服务器收到你的请求后，回复给你的数据包，里面包含了网页内容。

#### **答案解析**

**正确答案**: **d. All of these (以上皆可)**

**原因**:
1.  **请求过程**:
    * 客户端A发送请求时，数据包的端口信息是：
        * **源端口**: 1000 (客户端A的本地端口)
        * **目的端口**: 80 (因为是HTTP请求，默认访问服务器的80端口)
2.  **响应过程**:
    * 当UNSW的Web服务器回复时，它会把源和目的端口**反过来**。
    * 服务器发出的响应包，其端口信息是：
        * **源端口**: 80 (服务器的HTTP服务端口)
        * **目的端口**: **1000** (客户端A当时发起请求的端口)
3.  **NAT的作用**:
    * NAT路由器在转发这个请求时，会把源IP和源端口修改掉。例如，它可能会把 `10.2.0.A:1000` 修改为 `138.76.29.7:4999`。
    * 当服务器回复时，它会回复给 `138.76.29.7:4999`。
    * NAT路由器收到后，根据NAT表，再把目的地址改回 `10.2.0.A:1000`。

**结论**: 无论NAT是否修改了端口号，最终从服务器的角度看，它收到的请求源端口是多少，它回复时的**目的端口**就是多少。但是，题目问的是 “What could be a possible destination port number in the HTTP response message **sent by the UNSW web server**”。这个问题的措辞有歧义。
* 如果指服务器回复给**NAT路由器**的那个包，目的端口可能是 `4999`, `2050` 等任何NAT路由器分配的临时端口。
* 如果指最终送达**客户端A**的那个包，目的端口**必须**是 `1000`。

然而，这道题的正确答案是“All of these”，这暗示了一个不同的解读：客户端（浏览器）在发起连接时，可以选择**任何一个未被占用的高位端口**作为其源端口。虽然题目说“local port...is 1000”，但如果把它理解为一个例子，那么客户端完全有可能使用 `4999`, `2050` 或 `1000` 作为其请求的源端口。因此，服务器响应时的目的端口也可能是这些值中的任何一个。这是最符合标准答案逻辑的解释。

---
### **第二题: HTTP响应报文中的IP和端口**

#### **题干翻译**
> **翻译**: ...请问，在UNSW的Web服务器为响应这个GET请求而发回的HTTP响应报文中，**源IP地址、源端口号和目的IP地址**分别是什么？

#### **答案解析**

**正确答案**: **a. 129.119.103.149, 80, and 138.76.29.7**

**原因**:
这个问题问的是服务器发回**给NAT路由器**的那个响应数据包。
1.  **源 (Source)**: 数据包是从哪里来的？它来自UNSW的Web服务器。
    * **源IP地址**: `129.119.103.149` (服务器的IP)
    * **源端口号**: `80` (因为是HTTP服务，所以从80端口发出)
2.  **目的 (Destination)**: 数据包要去哪里？它要去访问它的客户端，也就是NAT路由器的公共地址。
    * **目的IP地址**: `138.76.29.7` (NAT路由器的公共IP)
    * (目的端口号会是NAT分配的某个临时端口，但题目没问)

**结论**: 因此，响应报文的源IP是服务器IP，源端口是80，目的IP是NAT路由器的公共IP。选项a正确。

---
### **第三题: 本地网络的合法地址分配**

#### **题干翻译**
> **翻译**: ...请问，对于本地网络（即驻留在本地网络中的接口），下面哪一个是**合法的地址分配 (legitimate address allocation)**？

#### **答案解析**

**正确答案**: **d. None of these (以上都不是)**

**原因**:
1.  **私有网络范围**: 图中明确指出，本地网络使用的是 **`10.2.0.0/24`** 这个地址块。
2.  **`/24` 的含义**: 这个前缀意味着网络地址的前24位（即前三个数字 `10.2.0`）是固定的。只有最后一个数字可以在 `0` 到 `255` 之间变化。
3.  **分析选项**:
    * **a. `A: 10.2.0.2, B: 10.2.1.3, ...`**: `10.2.1.3` 的第三个数字是`1`，不属于 `10.2.0.x` 的范围，所以**不合法**。
    * **b. `A: 10.2.0.2, B: 10.2.0.3, C: 10.2.0.4, NAT Router: 138.76.29.4`**: 客户端A,B,C的地址是合法的。但是，`NAT Router: 138.76.29.4` 是一个**公共IP地址**。NAT路由器的**内部接口**也应该有一个属于 `10.2.0.x` 网络的私有IP（通常是 `10.2.0.1`），所以这个分配**不合法**。
    * **c. `A: 138.76.29.4, ...`**: 直接给客户端分配了公共IP地址，这违背了整个NAT私有网络的设计，所以**不合法**。

**结论**: 由于所有选项都存在不合法之处，因此正确答案是“以上都不是”。

---

[![1755149412053.png](https://youke1.picui.cn/s1/2025/08/14/689d74527575f.png)](https://youke1.picui.cn/s1/2025/08/14/689d74527575f.png)


图片中的标准答案是完全正确的。当一个数据包从内网穿过NAT路由器流出时，路由器通常会修改以下**四个**字段：

* **`Source IP address` (源IP地址)**
* **`Source port number` (源端口号)**
* **`IP checksum` (IP校验和)**
* **`Transport checksum` (传输层校验和)**

下面我们来详细解析为什么这四个字段都需要被更改。

---
### **1 & 2. 源IP地址和源端口号 (核心功能)**

这是NAT路由器最基本、最核心的工作。

* **`Source IP address` (源IP地址)**:
    这是“网络地址转换”中“**地址**”的部分。路由器必须将数据包的源地址从一个无法在公网上路由的**私有IP**（例如 `192.168.1.100`）替换成它自己的**公共IP地址**。否则，互联网上的服务器将不知道把回复发送到哪里。

* **`Source port number` (源端口号)**:
    这是“网络地址转换”中“**端口**”的部分（这种模式也常被称为PAT或NAPT）。这是为了区分内部网络中的不同设备。如果您的手机和电脑都恰好使用了相同的源端口号（例如50000）去访问同一个网站，路由器就需要将它们映射到**不同**的临时公共端口号（例如手机映射到61001，电脑映射到61002）。这样，当收到回复时，路由器才能根据不同的端口号，准确地将数据送回给正确的设备。

### **3. & 4. IP校验和与传输层校验和 (连锁反应)**

这两个字段的修改，是上述地址和端口修改所导致的**必然连锁反应**。

* **`IP checksum` (IP校验和)**:
    * IP数据包的头部有一个“校验和”字段，它是一个根据IP头部所有内容计算出的数值，用于检查IP头部在传输过程中是否因为错误而被意外修改。
    * 因为NAT**修改了IP头部的一个关键内容（源IP地址）**，所以原始的IP校验和就立刻失效、变成了一个错误的值。
    * 因此，路由器**必须**为修改后的新IP头部重新计算一个新的、正确的IP校验和，并用它覆盖掉旧的校验和。

* **`Transport checksum` (传输层校验和)**:
    * 同样，传输层（TCP或UDP）的头部也有一个校验和。这个校验和的计算范围更广，它不仅包含了传输层头部和数据，还包含了一个“伪头部”，这个伪头部里就有**源IP地址**和**目的IP地址**。
    * 因为NAT**修改了源IP地址和源端口号**，这两者都是计算传输层校验和的原始数据之一，所以原始的传输层校验和也同样失效了。
    * 因此，路由器也**必须**重新计算一个新的传输层校验和。

---
### **总结**

简单来说，NAT的工作可以分为两步：

1.  **主动行为**: 为了实现其功能，主动修改 **源IP地址** 和 **源端口号**。
2.  **被动修正**: 因为修改了地址和端口，导致原始的 **IP校验和** 与 **传输层校验和** 失效，必须重新计算并更新它们，以保证数据包的完整性和可路由性。

而目标IP、目标端口和协议字段在出站时是不需要被修改的。

---

[![1755149539809.png](https://youke1.picui.cn/s1/2025/08/14/689d74d2af343.png)](https://youke1.picui.cn/s1/2025/08/14/689d74d2af343.png)

是response，是返回的。所以应该是router。  

---
### **第一步：分析初始请求 (SYN包)**

这是三次握手的第一步，由客户端（`192.168.0.2`）发起。

1.  **客户端A发出SYN包**:
    * **源 (Source)**: `192.168.0.2` (IP), `6700` (端口)
    * **目的 (Destination)**: `34.5.6.7` (IP), `80` (端口，HTTP的默认端口)

2.  **NAT路由器转发SYN包**:
    * NAT路由器收到这个包，将其**源地址和端口**修改为自己的公共地址和一个临时端口。
    * **修改后的SYN包 (发往互联网)**:
        * **源 (Source)**: `22.33.44.55` (IP), `4001` (端口)
        * **目的 (Destination)**: `34.5.6.7` (IP), `80` (端口)
    * 同时，路由器在NAT表中创建了一条映射规则，用于处理返回的包：
      `外部(22.33.44.55:4001) <---> 内部(192.168.0.2:6700)`

---
### **第二步：分析服务器的响应 (SYN-ACK包)**

这是三次握手的第二步，由Web服务器（`34.5.6.7`）回复。这个问题问的正是**这个阶段**的数据包信息。

* **服务器的角色**: 服务器收到了一个来自 `22.33.44.55:4001` 的请求。它并不知道内部客户端 `192.168.0.2` 的存在。因此，它会直接回复给它看到的那个源地址。

* **服务器发出的SYN-ACK包**:
    * **源 (Source)**: `34.5.6.7` (IP), `80` (端口)
    * **目的 (Destination)**: `22.33.44.55` (IP), `4001` (端口)

### **第三步：填写答案**

题目问的是“**in the IP datagram encapsulating the SYN-ACK response sent from the web server**”，也就是Web服务器发出的那个SYN-ACK包中的目的IP和目的端口是什么。

根据我们第二步的分析：

* **Destination IP Address**: **`22.33.44.55`**
* **Destination Port Number**: **`4001`**

---
#### **(补充) 第四步：NAT路由器处理返回的包**

虽然题目没有问，但为了完整性，我们看一下这个SYN-ACK包到达NAT路由器后会发生什么：

1.  NAT路由器收到一个目标为 `22.33.44.55:4001` 的数据包。
2.  它查询自己的NAT转换表，找到了对应的内部地址：`192.168.0.2:6700`。
3.  路由器会再次修改数据包，这次是修改**目的地址和端口**。
4.  **修改后的SYN-ACK包 (发往内部网络)**:
    * **源 (Source)**: `34.5.6.7` (IP), `80` (端口)
    * **目的 (Destination)**: `192.168.0.2` (IP), `6700` (端口)

这样，客户端 `192.168.0.2` 就能正确收到服务器的响应了。

---

[![1755153313406.png](https://youke1.picui.cn/s1/2025/08/14/689d8390a4947.png)](https://youke1.picui.cn/s1/2025/08/14/689d8390a4947.png)

### **题干翻译与词汇解释**

**总述部分**:
> **原句**: Sheldon Cooper is designing a Network Address Translator (NAT) device to use at home so that multiple computers share a single global IP address (nat ip).
>
> **翻译**: 谢尔顿·库珀（Sheldon Cooper）正在设计一个家用的**网络地址转换（NAT）**设备，以便让多台电脑可以共享一个单一的**全局IP地址（nat ip）**。

* **`designing` (设计)**: 指创建或构建。
* **`multiple computers` (多台电脑)**: 指家庭网络中的多个设备。
* **`share a single global IP address` (共享一个单一的全局IP地址)**: 这是NAT的核心功能，即将多个私有地址映射到一个公共地址。

**问题 (a)**:
> **原句**: In his first attempt Sheldon designs a NAT, which maps an outgoing {source ip, source port, destination ip, destination port} tuple to {nat ip, new port, destination ip, destination port}. To his surprise, he finds that routers in the Internet drop every packet sent by his NAT. What is missing in Sheldon's NAT design?
>
> **翻译**: 在第一次尝试中，谢尔顿设计了一个NAT，它可以将一个出站数据包的四元组 `{源ip, 源端口, 目的ip, 目的端口}` 映射为 `{nat ip, 新端口, 目的ip, 目的端口}`。令他惊讶的是，他发现互联网上的路由器会**丢弃 (drop)** 每一个由他的NAT发出的数据包。请问，谢尔顿的NAT设计中**缺少了什么 (what is missing)**？

* **`attempt` (尝试)**: 指一次努力或实验。
* **`maps` (映射)**: 指建立一种对应关系。
* **`outgoing` (出站的)**: 指从私有网络发往公共互联网的数据包。
* **`tuple` (元组)**: 指一组有序的元素，这里指构成TCP/IP连接的四个关键部分。
* **`drop every packet` (丢弃每一个包)**: 指路由器因为数据包不合法而将其丢弃，不予转发。

**问题 (b)**:
> **原句**: Now assume that Sheldon has corrected the above problem. He now finds that he can successfully browse the Web through the NAT, but he cannot use FTP. Why?
>
> **翻译**: 现在假设谢尔顿已经修正了上述问题。他发现他现在可以成功地通过NAT浏览网页了，但是他**无法使用FTP (cannot use FTP)**。为什么？

* **`corrected` (修正了)**: 指修复了问题(a)中的缺陷。
* **`successfully browse the Web` (成功地浏览网页)**: 指HTTP/HTTPS协议可以正常工作。
* **`FTP (File Transfer Protocol)` (文件传输协议)**: 一种用于在网络上传输文件的标准协议。

---
### **答案解析**

#### **问题 (a) 的解答：缺少了什么？**

谢尔顿的设计只修改了IP地址和端口号，但他忽略了一个关键的连锁反应：**修改了IP头部或TCP/UDP头部的内容后，必须重新计算并更新它们的校验和 (Checksum)**。

1.  **IP校验和 (IP Checksum)**:
    * IP数据包的头部包含一个校验和字段，用于验证IP头部在传输过程中是否出错。
    * 谢尔顿的NAT修改了IP头部中最重要的字段之一——**源IP地址**。
    * 这个改动使得原始的IP校验和失效了。互联网上的路由器收到这个包后，会重新计算校验和并与包中的旧值对比，发现不匹配，便认为该数据包在传输中已损坏，因此会将其**丢弃**。
    * **缺失的步骤**: 谢尔顿的NAT在修改源IP地址后，**必须重新计算整个IP头部的校验和**，并用新值更新该字段。

2.  **传输层校验和 (Transport Layer Checksum - TCP/UDP Checksum)**:
    * 同样，TCP和UDP的头部也包含一个校验和。这个校验和的计算范围不仅包括TCP/UDP头部，还包括一个包含**源IP地址**、目的IP地址等信息的“伪头部”。
    * 谢尔顿的NAT修改了**源IP地址**和**源端口号**，这两者都是计算传输层校验和的原始数据。
    * 这同样使得原始的TCP/UDP校验和失效。
    * **缺失的步骤**: 谢尔顿的NAT在修改地址和端口后，也**必须重新计算传输层的校验和**。

**结论**: 谢尔顿的设计中缺少了**对IP校验和与传输层校验和的重新计算与更新**。

#### **问题 (b) 的解答：为什么FTP无法使用？**

这个问题特指FTP的**主动模式 (Active Mode)**，它与NAT的兼容性非常差。

1.  **FTP的工作方式**: 主动模式的FTP需要建立两个独立的TCP连接：
    * **控制连接 (Control Connection)**: 客户端向服务器的21端口发起，用于发送命令（如用户名、密码、要下载的文件名等）。这个连接通常可以正常通过NAT。
    * **数据连接 (Data Connection)**: 当需要传输文件时，客户端会通过控制连接发送一个 `PORT` 命令给服务器。**问题的关键就在这里**。

2.  **`PORT` 命令的问题**:
    * `PORT` 命令的作用是客户端告诉服务器：“请你（服务器）主动向我的**某个IP地址**和**某个端口号**发起一个新的连接来传输数据。”
    * 这个命令的内容是明文的，例如 `PORT 192,168,1,100,20,21` (代表IP `192.168.1.100`，端口 `20*256+21=5141`)。
    * 客户端发送的是它自己的**私有IP地址 (`192.168.1.100`)**。

3.  **NAT的“盲点”**:
    * 一个基础的NAT设备（像谢尔顿设计的）只会查看和修改IP层和传输层的头部（地址和端口），它**不会去检查和修改应用层数据（`PORT`命令的内容）**。
    * 因此，这个包含了私有地址`192.168.1.100`的`PORT`命令被原封不动地发送到了互联网上的FTP服务器。

4.  **连接失败**:
    * FTP服务器收到了这个命令，并尝试向IP地址 `192.168.1.100` 发起数据连接。
    * 但 `192.168.1.100` 是一个私有地址，在公共互联网上是不可路由的。服务器根本找不到这个地址，因此数据连接建立失败，文件无法传输。

**结论**: FTP（主动模式）无法工作，因为客户端在应用层载荷中发送了自己的私有IP地址，而基础的NAT设备无法识别并转换这个应用层数据，导致服务器无法连接回客户端。
*(注：现代的一些高级NAT路由器或防火墙具备“应用层网关(ALG)”功能，可以智能地检查并修改FTP的`PORT`命令内容来解决这个问题。FTP的被动模式(Passive Mode)也是为解决此问题而设计的。)*

---

[![1755153530201.png](https://youke1.picui.cn/s1/2025/08/14/689d84691a0f2.png)](https://youke1.picui.cn/s1/2025/08/14/689d84691a0f2.png)

specify 